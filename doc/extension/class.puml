@startuml Class
title Class Diagram of Extension

class "manifest.json" as ManifestJson <<JSON>> {
    + name: "GitHub Actions Dashboard"
    + version: "0.1.0"
    + manifest_version: 3
    + permissions: ["storage", "tabs", "scripting"]
    + host_permissions: ["https://github.com/*"]
    --
    Defines extension metadata and entry points
}

class "package.json" as PackageJson <<JSON>> {
    + dependencies: React, Recharts, etc.
    + scripts: build, dev, pack
    --
    Manages npm dependencies and build scripts
}

class "vite.config.js" as ViteConfig <<Config>> {
    + Configures Vite bundler
    + Entry points: main.jsx, background.js, contentScript.js
    + Output: build/ folder
}

class "background.js" as BackgroundJs <<Service Worker>> {
    - wsCache: Map<repo, {runs, isComplete, startDate, endDate}>
    - activeWebSocket: WebSocket
    - currentRepo: string
    - currentTabId: number
    --
    + onMessage(request, sender, sendResponse)
    + startWebSocketExtraction(repo, filters, tabId)
    + onTabsRemoved(tabId, removeInfo)
    + onTabsUpdated(tabId, changeInfo, tab)
    --
    Manages WebSocket connections and caching
    Ensures single active WebSocket per repo
    Persists data to chrome.storage.local
}

class "contentScript.js" as ContentScriptJs <<Content Script>> {
    - dashboardContainer: HTMLElement
    - dashboardButton: HTMLElement
    - isDashboardActive: boolean
    - previousUrl: string
    --
    + extractRepoFromURL(url): string
    + detectRepoOnGitHub()
    + injectDashboardButton()
    + showDashboard()
    + hideDashboard()
    + observeUrlChanges()
    --
    Injects dashboard UI on GitHub pages
    Detects repo from URL and sends to background
    Manages dashboard visibility and navigation
}

class "websocket.js" as WebsocketJs <<Module>> {
    - _runsByRepo: Map<repo, runs[]>
    - _progressCallbacks: Map<repo, callback>
    - _pendingResolves: Map<repo, resolve>
    - _pendingRejects: Map<repo, reject>
    --
    + fetchDashboardDataViaWebSocket(repo, filters, onProgress): Promise
    + filterRunsLocally(filters, repo): dashboardData
    + getWebSocketCacheStatus(repo): {cached, isComplete, itemCount}
    + clearWebSocketCache(repo)
    - convertRunsToDashboard(runs, repo, filters): dashboardData
    - calculateRunStats(runs): {total, success, failed, successRate}
    - calculateDurationStats(runs): {avg, median, min, max}
    - aggregateRunsByDate(runs): timeSeriesData
    - calculateBranchStats(runs): branchComparison
    - calculateWorkflowStats(runs): workflowMetrics
    --
    Listens to chrome.storage.onChanged events
    Processes raw runs into dashboard metrics
    Provides public API for data fetching/filtering
}

class "main.jsx" as MainJsx <<Entry Point>> {
    + createRoot()
    + render(<Dashboard />)
    --
    Bootstraps React app into dashboard.html
}

class "Dashboard.jsx" as DashboardJsx <<React Component>> {
    - data: object
    - loading: boolean
    - error: string
    - progress: {items, complete, isStreaming}
    - filters: {workflow, branch, actor, start, end}
    - availableFilters: {workflows, branches, actors}
    - currentRepo: string
    - dataLoaded: boolean
    --
    + loadDashboardData(): Promise
    + applyLocalFilters(rawData): filteredData
    + handleFilterChange(filterType, value)
    + useEffect(): initialization and filter updates
    --
    Main UI logic with state management
    Renders charts (PieChart, LineChart, BarChart)
    Handles user interactions and filtering
}

class "popup.html" as PopupHtml <<HTML>> {
    + Contains token input form
    + Links to popup.js and popup.css
}

class "popup.js" as PopupJs <<Script>> {
    + DOMContentLoaded event handler
    + Save GitHub token to chrome.storage
    + Load saved token on popup open
    + Display token status messages
    --
    Manages GitHub token configuration
}

class "dashboard.html" as DashboardHtml <<HTML>> {
    + <div id="root"></div>
    + Loads bundled React app (main.jsx)
    + CSP-compliant structure
}

class "dashboardStyles.css" as DashboardStylesCss <<CSS>> {
    + Dashboard layout and chart styling
    + Filter dropdowns and controls
    + Responsive design rules
}

class "popup.css" as PopupCss <<CSS>> {
    + Popup window styling
    + Token input form layout
}

class "assets/" as AssetsFolder <<Folder>> {
    + dashboard.png (extension icon)
    + Other static resources
}

class "build/" as BuildFolder <<Folder>> {
    + background.js (compiled)
    + contentScript.js (compiled)
    + manifest.json (copied)
    + assets/ (bundled React chunks)
    + src/dashboard/dashboard.html
    + src/popup/popup.html
    --
    Production-ready extension files
    Generated by Vite build process
}

class "scripts/assemble.js" as AssembleJs <<Build Script>> {
    + Copies files to build/
    + Assembles final extension structure
}

class "Backend Server" as BackendServer <<WebSocket>> {
    + ws://localhost:3000/data/{repo}
    + Query params: token, startDate, endDate
    --
    Streams workflow runs to background.js
    Handles pagination and data aggregation
}

class "chrome.storage.local" as ChromeStorageLocal <<Chrome API>> {
    + Stores: wsRuns, wsStatus, githubToken
    + Persists across browser sessions
    --
    Shared storage for extension contexts
}

class "chrome.runtime" as ChromeRuntime <<Chrome API>> {
    + sendMessage() for inter-script communication
    + onMessage listener in background
    --
    Messaging between extension components
}

' Configuration relationships
ManifestJson --> BackgroundJs : Registers as service_worker
ManifestJson --> ContentScriptJs : Injects on github.com/*
ManifestJson --> PopupHtml : Defines action.popup
PackageJson --> ViteConfig : Used by build scripts
ViteConfig --> BuildFolder : Generates output
ViteConfig --> AssembleJs : Runs post-build

' Core logic relationships
BackgroundJs --> BackendServer : WebSocket connection
BackgroundJs --> ChromeStorageLocal : Writes wsRuns, wsStatus
BackgroundJs --> ChromeRuntime : Listens to messages
WebsocketJs --> ChromeStorageLocal : Reads via onChanged listener
WebsocketJs --> ChromeRuntime : Sends messages to background.js
WebsocketJs --> DashboardJsx : Returns processed data
ContentScriptJs --> ChromeRuntime : Sends UPDATE_REPO message
ContentScriptJs --> DashboardHtml : Injects into GitHub page

' UI relationships
MainJsx --> DashboardJsx : Renders component
DashboardJsx --> WebsocketJs : Calls fetchDashboardDataViaWebSocket()
PopupJs --> ChromeStorageLocal : Saves/loads githubToken
PopupHtml --> PopupJs : Loads script
DashboardHtml --> MainJsx : Loads React entry point

' Styling relationships
DashboardJsx ..> DashboardStylesCss : Uses classes
PopupHtml ..> PopupCss : Uses styles
DashboardJsx ..> AssetsFolder : Uses icons

' Notes
note right of ManifestJson
  Root config file
  Defines permissions and CSP
  References all entry points
end note

note right of BackgroundJs
  Service worker (persistent)
  Single active WebSocket
  Caches per repo in Map + storage
end note

note right of WebsocketJs
  Client-side data layer
  Transforms raw runs to metrics
  Supports local filtering
end note

note right of DashboardJsx
  React component with hooks
  Manages filters and state
  Renders Recharts visualizations
end note

note right of ContentScriptJs
  Runs on all GitHub pages
  Detects repo from URL
  Injects dashboard on demand
end note

note right of ChromeStorageLocal
  Persistent storage API
  Shares data across contexts
  Keys: wsRuns, wsStatus, githubToken
end note

@enduml